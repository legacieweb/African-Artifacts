<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart | African Artifacts</title>
  <style>
    :root {
      /* Warm African-inspired colors */
      --primary-gold: #D4A574;
      --dark-brown: #6B4423;
      --warm-cream: #F5E6D3;
      --accent-orange: #E8722C;
      --accent-green: #6B8E23;
      --success-green: #52B788;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d4b8 100%);
      color: #3d2817;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Background image container - add your image URL in background-image */
    .page-background {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url(''); /* ADD YOUR BACKGROUND IMAGE URL HERE */
      background-size: cover;
      background-position: center;
      opacity: 0.1;
      pointer-events: none;
      z-index: -1;
    }

    header {
      background: linear-gradient(135deg, #6B4423 0%, #8B5A2B 100%);
      color: #fff;
      padding: 3rem 2rem;
      text-align: center;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }

    /* Optional header background image layer */
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url(''); /* ADD YOUR HEADER BACKGROUND IMAGE HERE */
      background-size: cover;
      background-position: center;
      opacity: 0.15;
      pointer-events: none;
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
      text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
      position: relative;
      z-index: 1;
    }

    header p {
      font-size: 1.3rem;
      font-style: italic;
      color: #FFE4B5;
      font-weight: 600;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      position: relative;
      z-index: 1;
    }

    .cart-container {
      flex: 1;
      padding: 3rem 2rem;
      max-width: 900px;
      margin: auto;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(107, 68, 35, 0.2);
      overflow-x: auto;
    }

    h2 {
      text-align: center;
      margin-bottom: 1rem;
      color: #6B4423;
      font-size: 2.4rem;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.5);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: #3d2817;
      min-width: 600px;
    }

    thead th {
      text-align: center;
      padding: 1.2rem;
      border-bottom: 2px solid #D4A574;
      font-weight: 500;
      white-space: nowrap;
    }

    tbody td {
      text-align: center;
      padding: 1.2rem;
      border-bottom: 2px solid #D4A574;
      font-weight: 500;
      white-space: nowrap;
    }

    th {
      background: linear-gradient(135deg, #D4A574 0%, #C9945A 100%);
      color: #fff;
      font-weight: bold;
      font-size: 1.05rem;
    }

    td {
      font-size: 0.95rem;
    }

    tbody td[data-label]::before {
      display: none;
    }

    .quantity-controls {
      display: inline-flex;
    }

    tr:hover {
      background-color: rgba(212, 165, 116, 0.1);
      transition: 0.2s ease;
    }

    .quantity-btn {
      background: linear-gradient(135deg, #E8722C 0%, #D65A1F 100%);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
      font-weight: bold;
    }

    .quantity-controls {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
    }

    .quantity-value {
      display: inline-block;
      min-width: 1.5rem;
      text-align: center;
      font-weight: 600;
    }

    .quantity-btn:hover {
      background: linear-gradient(135deg, #F08A3D 0%, #E8722C 100%);
      transform: scale(1.05);
    }

    .total {
      text-align: right;
      margin-top: 1.5rem;
      font-size: 1.8rem;
      color: #6B4423;
      font-weight: bold;
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 2.5rem;
      flex-wrap: wrap;
    }

    .btn {
      background: linear-gradient(135deg, #6B8E23 0%, #556B2F 100%);
      border: none;
      color: #fff;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: 0.3s;
      box-shadow: 0 4px 12px rgba(107, 142, 35, 0.3);
    }

    .btn:hover {
      background: linear-gradient(135deg, #7BA833 0%, #6B8E23 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(107, 142, 35, 0.4);
    }

    .btn-checkout {
      background: linear-gradient(135deg, #E8722C 0%, #D65A1F 100%);
      font-weight: bold;
      font-size: 1.1rem;
      padding: 1.2rem 2.5rem;
      box-shadow: 0 4px 12px rgba(232, 114, 44, 0.3);
    }

    .btn-checkout:hover {
      background: linear-gradient(135deg, #F08A3D 0%, #E8722C 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(232, 114, 44, 0.4);
    }

    .payment-info {
      background: linear-gradient(135deg, rgba(232, 114, 44, 0.08) 0%, rgba(212, 165, 116, 0.08) 100%);
      border-left: 5px solid #E8722C;
      padding: 1.2rem;
      margin: 1.5rem 0;
      border-radius: 8px;
      color: #6B4423;
      font-size: 0.98rem;
      font-weight: 500;
    }

    .payment-options {
      background: linear-gradient(135deg, rgba(212, 165, 116, 0.05) 0%, rgba(82, 183, 136, 0.05) 100%);
      border-radius: 12px;
      padding: 1.8rem;
      margin: 1.8rem 0;
      border: 2px solid #D4A574;
    }

    .payment-option {
      display: flex;
      align-items: center;
      margin: 1.2rem 0;
      cursor: pointer;
      padding: 1rem;
      border-radius: 8px;
      transition: 0.3s;
      background: rgba(255, 255, 255, 0.6);
      border: 2px solid transparent;
    }

    .payment-option:hover {
      background: rgba(212, 165, 116, 0.15);
      border: 2px solid #D4A574;
    }

    .payment-option input[type="radio"] {
      margin-right: 1rem;
      cursor: pointer;
      width: 20px;
      height: 20px;
      accent-color: #E8722C;
    }

    .payment-option label {
      cursor: pointer;
      flex: 1;
      color: #3d2817;
    }

    .upfront-amount {
      font-size: 1.3rem;
      color: #E8722C;
      font-weight: bold;
    }

    .empty-cart {
      text-align: center;
      color: #6B4423;
      font-size: 1.3rem;
      margin-top: 2rem;
    }

    footer {
      background: linear-gradient(135deg, #6B4423 0%, #8B5A2B 100%);
      color: #fff;
      text-align: center;
      padding: 1.5rem;
      margin-top: auto;
      box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.1);
    }

    a {
      color: #FFE4B5;
      text-decoration: none;
      font-weight: bold;
      transition: 0.3s;
    }

    a:hover {
      color: #FFDAB9;
      text-decoration: underline;
    }

    /* Welcome message with accent colors */
    .welcome-message {
      text-align: center;
      margin-bottom: 2rem;
      font-style: italic;
      color: #E8722C;
      font-size: 1.1rem;
      font-weight: 500;
    }

    /* Payment summary styling */
    #payment-summary {
      background: linear-gradient(135deg, rgba(232, 114, 44, 0.1) 0%, rgba(82, 183, 136, 0.1) 100%) !important;
      border: 2px solid #D4A574 !important;
      color: #6B4423 !important;
      border-radius: 8px !important;
    }

    #amount-to-pay {
      color: #E8722C !important;
    }

    /* Header with Auth Buttons */
    .header-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 1.5rem;
      background: rgba(0, 0, 0, 0.4);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-auth-buttons {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .auth-btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .auth-btn.login {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .auth-btn.login:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .auth-btn.primary {
      background: linear-gradient(135deg, #f28c44 0%, #e8722c 100%);
      color: white;
    }

    .auth-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(232, 114, 44, 0.4);
    }

    .auth-btn.logout {
      background: rgba(232, 114, 44, 0.2);
      color: #ff9966;
      border: 1px solid rgba(232, 114, 44, 0.4);
    }

    .auth-btn.logout:hover {
      background: rgba(232, 114, 44, 0.3);
    }

    .cart-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      color: white;
      cursor: pointer;
      transition: transform 0.2s ease;
      padding: 0.5rem;
    }

    .cart-btn:hover {
      transform: scale(1.1);
    }

    .cart-icon {
      font-size: 1.5rem;
    }

    .cart-badge {
      position: absolute;
      top: -0.5rem;
      right: -0.5rem;
      background: #ff6b35;
      color: white;
      border-radius: 50%;
      width: 1.3rem;
      height: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);
    }

    @media (max-width: 768px) {
      header {
        padding: 2rem 1rem;
      }

      header h1 {
        font-size: 2rem;
      }

      header p {
        font-size: 1.1rem;
      }

      .cart-container {
        padding: 2rem 1rem;
        margin: 0 1rem;
        border-radius: 12px;
      }

      h2 {
        font-size: 2rem;
      }

      table {
        min-width: unset;
        display: block;
      }

      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
        width: 100%;
      }

      thead tr {
        display: none;
      }

      tr {
        margin-bottom: 1rem;
        border: 1px solid rgba(212, 165, 116, 0.4);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.85);
        padding: 1rem;
      }

      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0;
        font-size: 0.9rem;
        gap: 0.8rem;
        text-align: right;
      }

      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #6B4423;
        text-align: left;
        margin-right: 1.2rem;
        flex: 1;
      }

      .quantity-btn {
        padding: 0.6rem;
        font-size: 0.85rem;
      }

      .quantity-controls {
        justify-content: flex-end;
      }

      .total {
        font-size: 1.5rem;
        text-align: center;
      }

      .actions {
        flex-direction: column;
        gap: 1rem;
      }

      .btn {
        width: 100%;
        padding: 0.9rem 1.5rem;
        font-size: 0.95rem;
      }

      .btn-checkout {
        padding: 1rem 2rem;
        font-size: 1rem;
      }

      .payment-info {
        padding: 1rem;
        font-size: 0.9rem;
      }

      .payment-options {
        padding: 1.5rem;
      }

      .payment-option {
        padding: 0.8rem;
        margin: 0.8rem 0;
      }

      .upfront-amount {
        font-size: 1.1rem;
      }

      .empty-cart {
        font-size: 1.1rem;
      }

      footer {
        padding: 1.2rem;
      }

      .welcome-message {
        font-size: 1rem;
      }
    }

    @media (max-width: 480px) {
      header {
        padding: 1.5rem 0.75rem;
      }

      header h1 {
        font-size: 1.8rem;
      }

      header p {
        font-size: 1rem;
      }

      .cart-container {
        padding: 1.5rem 0.75rem;
        margin: 0 0.5rem;
        border-radius: 8px;
      }

      h2 {
        font-size: 1.8rem;
      }

      th, td {
        padding: 0.6rem 0.3rem;
        font-size: 0.8rem;
      }

      td {
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
        gap: 0.4rem;
      }

      td::before {
        margin-right: 0;
      }

      .quantity-controls {
        width: 100%;
        justify-content: flex-start;
      }

      .quantity-btn {
        padding: 3px 6px;
        font-size: 0.75rem;
      }

      .total {
        font-size: 1.3rem;
      }

      .btn {
        padding: 0.8rem 1.2rem;
        font-size: 0.9rem;
      }

      .btn-checkout {
        padding: 0.9rem 1.8rem;
        font-size: 0.95rem;
      }

      .payment-info {
        padding: 0.8rem;
        font-size: 0.85rem;
      }

      .payment-options {
        padding: 1.2rem;
      }

      .payment-option {
        padding: 0.6rem;
        margin: 0.6rem 0;
      }

      .upfront-amount {
        font-size: 1rem;
      }

      .empty-cart {
        font-size: 1rem;
      }

      footer {
        padding: 1rem;
      }

      .welcome-message {
        font-size: 0.95rem;
      }

      .header-top-bar {
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
      }

      .header-auth-buttons {
        gap: 0.3rem;
      }

      .auth-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.7rem;
      }

      .cart-btn {
        padding: 0.3rem;
      }

      .cart-icon {
        font-size: 1.2rem;
      }

      .cart-badge {
        width: 1.1rem;
        height: 1.1rem;
        font-size: 0.6rem;
      }
    }

  </style>
</head>
<body>
  <!-- Background image layer - Edit the URL in CSS (.page-background) to add your image -->
  <div class="page-background"></div>

  <header>
    <h1>🛍️ Your Shopping Cart</h1>
    <p>“Karibu tena — your journey of culture continues!”</p>
  </header>

  <div class="cart-container">
    <h2>Items You’ve Selected</h2>
    <p class="welcome-message">Each piece tells a story — let’s make one yours.</p>
    <div id="cart-content"></div>
  </div>

  <footer>
    <p>&copy; 2025 African Artifacts | Crafted with Soul & Heritage</p>
    <p><a href="index.html">← Back to Home</a></p>
  </footer>

  <script src="js/api.js"></script>
  <script>
    const cartContainer = document.getElementById("cart-content");
    let currentCart = [];
    let validatedCart = [];
    let shippingCost = 0;
    let totalPrice = 0;
    let totalWithShippingAmount = 0;

    async function renderCart() {
      const storedCart = JSON.parse(localStorage.getItem("cart")) || [];

      if (storedCart.length === 0) {
        currentCart = [];
        validatedCart = [];
        shippingCost = 0;
        totalPrice = 0;
        totalWithShippingAmount = 0;
        cartContainer.innerHTML = `
          <p class="empty-cart">Your cart is empty for now 😌</p>
          <div class="actions">
            <a href="index.html" class="btn">Continue Shopping</a>
          </div>
        `;
        return;
      }

      currentCart = storedCart.map((item, index) => ({
        ...item,
        originalIndex: index,
        quantity: item.quantity ? Number(item.quantity) : 1,
        price: Number(item.price) || 0,
        id: item.id || item.productId || undefined,
        productId: item.productId || item.id || undefined
      }));

      const itemsForValidation = currentCart
        .filter(item => item.id || item.productId)
        .map(item => ({
          productId: item.id || item.productId,
          quantity: item.quantity
        }));

      let validationResult = {};

      if (itemsForValidation.length && typeof validateCart === "function" && typeof isLoggedIn === "function" && isLoggedIn()) {
        validationResult = await validateCart(itemsForValidation);
      }

      const validatedItems = Array.isArray(validationResult.items) && validationResult.items.length ? validationResult.items : currentCart;

      validatedCart = validatedItems.map((item, index) => {
        const match = currentCart.find(c => item.productId && (c.id === item.productId || c.productId === item.productId)) || currentCart[index] || {};
        const resolvedPrice = Number(match.price ?? item.price ?? 0);
        const price = Number.isFinite(resolvedPrice) ? resolvedPrice : 0;
        const resolvedQuantity = Number(item.quantity ?? match.quantity ?? 1);
        const quantity = Number.isFinite(resolvedQuantity) && resolvedQuantity > 0 ? resolvedQuantity : 1;
        return {
          name: match.name || item.name || 'Unknown Item',
          size: match.size || item.size || 'One Size',
          price,
          quantity,
          productId: item.productId || match.productId || match.id || `local-${match.originalIndex ?? index}`,
          warning: item.warning,
          originalIndex: match.originalIndex ?? index
        };
      });

      const calculatedTotal = validatedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      totalPrice = validationResult.totalPrice && validationResult.totalPrice > 0 ? validationResult.totalPrice : calculatedTotal;
      if (!Number.isFinite(totalPrice)) totalPrice = calculatedTotal;

      let shippingResult = null;
      if (typeof calculateShipping === "function") {
        shippingResult = await calculateShipping('Kenya', totalPrice);
      }

      shippingCost = Number(shippingResult?.shippingCost ?? 0);
      if (!Number.isFinite(shippingCost) || shippingCost < 0) shippingCost = 0;

      totalWithShippingAmount = Number(shippingResult?.totalWithShipping ?? (totalPrice + shippingCost));
      if (!Number.isFinite(totalWithShippingAmount)) totalWithShippingAmount = totalPrice + shippingCost;

      let cartHTML = `
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Size</th>
              <th>Price (Ksh)</th>
              <th>Quantity</th>
              <th>Subtotal</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      validatedCart.forEach(item => {
        const subtotal = item.price * item.quantity;
        const warning = item.warning ? `<br/><small style="color: #E8722C;">${item.warning}</small>` : '';

        cartHTML += `
          <tr>
            <td data-label="Item">${item.name}${warning}</td>
            <td data-label="Size"><strong>${item.size || 'One Size'}</strong></td>
            <td data-label="Price (Ksh)">${item.price.toFixed(2)}</td>
            <td data-label="Quantity">
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="changeQuantity(${item.originalIndex}, -1)">−</button>
                <span class="quantity-value">${item.quantity}</span>
                <button class="quantity-btn" onclick="changeQuantity(${item.originalIndex}, 1)">+</button>
              </div>
            </td>
            <td data-label="Subtotal">${subtotal.toFixed(2)}</td>
            <td data-label="Action"><button class="quantity-btn" onclick="removeItem(${item.originalIndex})">Remove</button></td>
          </tr>
        `;
      });

      cartHTML += `</tbody>
        </table>
        <div class="total">
          Subtotal: Ksh ${totalPrice.toFixed(2)}<br/>
          Shipping: Ksh ${shippingCost.toFixed(2)}<br/>
          <strong>Total: Ksh ${totalWithShippingAmount.toFixed(2)}</strong>
        </div>

        <div class="checkout-info">
          <strong>🛒 Ready to Checkout?</strong><br/>
          <span style="font-size: 0.9rem; color: #666;">Review your items and proceed to secure checkout</span>
        </div>

        <div class="actions">
          <button class="btn" onclick="clearCart()">Clear Cart</button>
          <button class="btn btn-checkout" onclick="proceedToCheckout()">🚀 Proceed to Checkout</button>
        </div>
      `;

      cartContainer.innerHTML = cartHTML;
    }

    function changeQuantity(itemIdentifier, change) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      let itemIndex = cart.findIndex(item => item.id === itemIdentifier || item.productId === itemIdentifier);

      if (itemIndex === -1 && typeof itemIdentifier === 'number' && cart[itemIdentifier]) {
        itemIndex = itemIdentifier;
      }

      if (itemIndex === -1 && !Number.isNaN(parseInt(itemIdentifier, 10)) && cart[parseInt(itemIdentifier, 10)]) {
        itemIndex = parseInt(itemIdentifier, 10);
      }

      if (itemIndex !== -1) {
        const currentQuantity = Number(cart[itemIndex].quantity) || 1;
        const updatedQuantity = currentQuantity + change;
        if (updatedQuantity <= 0) {
          cart.splice(itemIndex, 1);
        } else {
          cart[itemIndex].quantity = updatedQuantity;
        }
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
    }

    function removeItem(itemIdentifier) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      let itemIndex = cart.findIndex(item => item.id === itemIdentifier || item.productId === itemIdentifier);

      if (itemIndex === -1 && typeof itemIdentifier === 'number' && cart[itemIdentifier]) {
        itemIndex = itemIdentifier;
      }

      if (itemIndex === -1 && !Number.isNaN(parseInt(itemIdentifier, 10)) && cart[parseInt(itemIdentifier, 10)]) {
        itemIndex = parseInt(itemIdentifier, 10);
      }

      if (itemIndex !== -1 && confirm("Remove this item from cart?")) {
        cart.splice(itemIndex, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
    }

    function clearCart() {
      if (confirm("Are you sure you want to clear your cart?")) {
        localStorage.removeItem("cart");
        renderCart();
      }
    }

    function proceedToCheckout() {
      if (validatedCart.length === 0) {
        alert("Your cart is empty!");
        return;
      }

      // Store cart data for checkout page
      const checkoutData = {
        items: validatedCart,
        currentCart: currentCart,
        totalPrice: totalPrice,
        shippingCost: shippingCost,
        totalWithShipping: totalPrice + shippingCost,
        timestamp: new Date().toISOString()
      };

      sessionStorage.setItem("checkoutData", JSON.stringify(checkoutData));

      // Redirect to checkout page
      window.location.href = "checkout.html";
    }

    document.addEventListener("DOMContentLoaded", function() {
      renderCart();
    });
  </script>
</body>
</html>
